apiVersion: kuttl.dev/v1
kind: TestStep
timeout: 10
commands:
  # Need to patch KUTTL's namespace to add the label so that the Everest Operator can reconcile resources from it.
  - command: kubectl patch ns ${NAMESPACE} -p '{"metadata":{"labels":{"app.kubernetes.io/managed-by":"everest"}}}' --type merge
  - command: kubectl apply -f https://raw.githubusercontent.com/percona/percona-xtradb-cluster-operator/v${PXC_OPERATOR_VERSION}/deploy/bundle.yaml -n "${NAMESPACE}"
  - command: kubectl apply -f ${OPERATOR_ROOT_PATH}/internal/data-importer/deploy/pxc
  - script: SYSTEM_NAMESPACE=$NAMESPACE MONITORING_NAMESPACE=$NAMESPACE DB_NAMESPACES=$NAMESPACE ${OPERATOR_ROOT_PATH}/bin/manager -metrics-bind-address :0 -health-probe-bind-address :0 -disable-webhook-server=true
    background: false
    skipLogOutput: false
